# AI_READ_ME (v10 Deep Map)

This file is the v10 implementation/architecture reference map.

## Governance Note
- Workflow authority order is defined by `AGENTS.md`.
- This document must not redefine SSOT priority; it only maps v10 architecture and invariants.

## Suggested Read Flow (v10 implementation context)
1) `PROJECT_BLUEPRINT.md` + `PROJECT_CONTEXT.md`  
2) `AGENTS.md` (authority + execution rules)  
3) Task spec in `codex_tasks/`  
4) `GEMINI_CODEX_PROTOCOL.md` (only when layout/SVG coordination is relevant)

---

## AI_READ_ME_MAP (Auto-generated)
- `v10/AI_READ_ME_MAP.md` is generated by `node scripts/gen_ai_read_me_map.mjs`.
- CI checks freshness via `node scripts/gen_ai_read_me_map.mjs --check`.

---

## Layer Rules (Hard Boundaries)
**Allowed imports**
- `core` imports: **only** other `core` modules
- `features` imports: `core` + `ui` only
- `ui` imports: **only** `ui` + `core` (no `features`)
- `app` can import `features` and `ui`

**Forbidden patterns**
- No `window` globals.
- No `eval` / `new Function`.
- No `src/lib` (deprecated).
- No Prisma client or generated code inside `src/`.
- HTML must be sanitized when using `innerHTML`.

**Aliases**
- `@core/*` → `v10/src/core/*`
- `@features/*` → `v10/src/features/*`
- `@ui/*` → `v10/src/ui/*`
- `@/*` → `v10/src/*`

---

## Directory Map (v10/src)
```
app/
  globals.css
  layout.tsx
  page.tsx
  api/community/route.ts
  api/trust/role/route.ts
core/
  engine/        (headless command bus: command registry, preflight, idempotency)
  contracts/     (NormalizedContent/RenderPlan/TTSScript/MultimodalAssetPayload/ToolResult/ToolRegistry contract types, guards, mappers)
  config/        (boardSpec, capabilities, typography defaults, rolePolicy + guards, theme token schema)
  export/        (export pipeline scaffold)
  extensions/    (manifest, registry, connectors, pluginLoader, mcpGateway, runtime scaffold, local runtime handshake/sandbox, AI asset pipeline)
  math/          (MathJax loader/render)
  migrations/    (migrateToV2 + modStudioMigration)
  persistence/   (buildPersistedDoc and doc-only shaping helpers)
  sanitize/      (richTextSanitizer)
  themes/        (theme presets + chalk actor theme)
  types/         (canvas data types)
  utils.ts       (shared utility helpers)
features/
  animation/     (animation model, plan/measure/runtime, modding contract)
  canvas/        (rendering layers, actors, objects, viewport)
  community/     (community domain store + client actions for post/comment/report)
  extensions/    (tool adapter interfaces/registry/provider ABI adapters/routing, local adapters, async jobs, command policy + command registrations)
  input-studio/  (DataInput headless hooks, schema editor, LLM draft/diff, approval queue payload, publish/rollback, validation pipeline)
  hooks/         (useSequence, usePersistence, useFileIO, useAudioPlayer, ...)
  layout/        (AppLayout, autoLayout, overview)
  mod-studio/    (GUI modding shell: policy/layout/modules/theme/publish/io)
  moderation/    (host moderation console view-model + panel)
  observability/ (audit logger runtime + redaction)
  policy/        (policy shadow comparison telemetry helpers)
  store/         (zustand state)
  sync/          (host/student asymmetric session sync hook + realtime backplane/conflict policy)
  toolbar/       (toolbar + panels)
ui/
  components/    (pure UI building blocks)
```

---

## Recent W6 Additions (task_207~212)
- Tablet shell profile:
  - `features/layout/useTabletShellProfile.ts` provides deterministic viewport class/orientation/safe-area profile.
  - Hotfix 2026-02-15: `useSyncExternalStore` viewport snapshot path now reuses stable snapshot references to prevent React #185 render-loop recurrence.
  - `features/layout/AppLayout.tsx` uses profile flags for compact insets, left-panel overlay, and bottom chrome safe-area padding.
- Thumb-zone toolbar:
  - `features/toolbar/ThumbZoneDock.tsx` adds compact mobile/tablet dock shell.
  - `features/toolbar/FloatingToolbar.tsx` now branches compact vs desktop toolbar while preserving command IDs/payload semantics.
- Gesture conflict lock path:
  - `useViewportStore` adds `isGestureLocked` + `activeGestureLocks` + acquire/release helpers.
  - Draw hooks (`useCanvas`, `useOverlayCanvas`) coordinate lock ownership (`canvas.draw`, `overlay.draw`) to prevent pan/draw conflicts.
- Low-end render profile:
  - `core/config/perfProfile.ts` resolves `low|normal|high` profile from navigator hints.
  - Draw hooks apply profile to coalesced-event sampling and laser trail/shadow intensity.
- Offline draft queue:
  - `features/input-studio/offlineDraftQueue.ts` adds JSON-safe bounded deterministic local queue (`max=50`, dedupe by deterministic id).
  - `useInputStudioLlmDraft` enqueues offline requests and returns explicit offline-queued error marker.

## Recent W7 Additions (task_213~218)
- Realtime backplane + role hardening:
  - `features/sync/realtime/backplane.ts` adds transport-agnostic realtime runtime (`websocket` preferred, BroadcastChannel fallback).
  - `features/sync/realtime/messageEnvelope.ts` defines strict sync envelope schema/validation.
  - `features/sync/realtime/roleSyncGuard.ts` and `features/sync/realtime/conflictPolicy.ts` enforce host-authoritative + monotonic/tie-break ingestion rules.
  - `features/sync/useAsymmetricSessionSync.ts` now consumes backplane/conflict guard and updates bounded remote presence state.
- Presence + laser stream:
  - `useSyncStore` now includes `lastHostEnvelopeCursor` and bounded `remotePresences`.
  - `features/canvas/PresenceOverlay.tsx` renders remote laser presence in student view with non-blocking overlay.
  - `features/hooks/useCanvas.ts` publishes quantized/throttled host laser sync points.
- Community + moderation baseline:
  - `core/contracts/community.ts` adds runtime validators for post/comment/report/moderation payloads.
  - `app/api/community/route.ts` adds fail-closed community API with host-token gate for `moderate-report`.
  - `features/community/*` adds client store/actions.
  - `features/moderation/*` adds host-only moderation console and audit stream surface.
  - `auditLogger` adds `moderation` channel and moderation decision audit events.

## Recent W8 Additions (task_220~223)
- Rights claim/takedown workflow:
  - `core/contracts/community.ts` now includes rights-claim, takedown-record, and traffic-signal contract guards.
  - `app/api/community/route.ts` supports `create-rights-claim` and host-only `review-rights-claim`.
  - Approved rights claim writes deterministic takedown records and replaces target content body with takedown marker.
- Ad policy enforcement gates:
  - `features/community/policy/adPolicy.ts` provides deterministic ad-policy text evaluation.
  - Community `create-post` / `create-comment` paths enforce ad-policy blocks before mutation.
- Invalid traffic telemetry:
  - `features/community/traffic/invalidTraffic.ts` provides bounded burst detection heuristics.
  - Community mutation actions emit bounded elevated/blocked traffic signals in snapshot state.
- Trust/safety SLO runtime:
  - Community API supports host-only `trust-safety-slo` action returning deterministic ops summary metrics.
  - Oncall playbook is documented in `codex_tasks/workflow/trust_safety_slo_oncall_runbook.md`.

---

## Canvas Layering (Notes)
- `features/canvas/PageViewport.tsx` exposes an `overlay` slot for screen-space layers (rendered outside the zoom/pan transform).
- `features/canvas/PageGuides.tsx` uses screen-space coordinates and expands its SVG viewport to avoid clipping while panning/zooming.
- `features/canvas/CanvasGuides.tsx` remains inside the transformed board space (alignment guides).

---

## Data Model (Core Concepts)
**Global steps**
- Step indices are **global**, not per-page.
- `currentStep` always references the global step index.
- `stepBlocks` is **1:1** with global steps (block index == step index).

**StepBlocks**
- Ordered blocks used to build layout.
- `kind` can be `content`, `line-break`, `column-break`, `page-break`.
- Every block (including breaks) increments the step index.

**AnchorMap**
- `AnchorMap: Record<pageId, Record<stepIndex, AnchorPosition[]>>`
- Used by playback cursor (anchor indicator); includes anchors for break blocks.

**audioByStep**
- Optional audio mapped by **global step index**.

**PersistedSlateDoc**
- Document-only payload for storage/export (no session fields).
- Includes optional `animationModInput` (format-agnostic external profile payload).

---

## Store Schemas (Zustand)

### 3-tier stores (authority layer)
- `useDocStore`: persisted document authority (`pages`, `pageOrder`, `pageColumnCounts`, `stepBlocks`, `anchorMap`, `audioByStep`, `animationModInput`)
- `useSyncStore`: shared/session-sync authority (`globalStep`, `laserPosition`, `sharedViewport`, `pendingAIQueue`, `lastHostEnvelopeCursor`, `remotePresences`)
- `useLocalStore`: local device/role authority (`role`, `trustedRoleClaim`, `isPanelOpen`, `localViewport`)
- `useModStudioStore`: mod-studio draft authority (`policy/layout/modules/theme`, snapshots, publish result)
  - `theme` draft now uses `presetId + globalTokens + moduleScopedTokens` (preset-first with override merge).

### Legacy interaction stores (still active)
- `useCanvasStore`: canvas mutation + layout/session actions (draw, page/step/block mutation facade)

### UI domain split stores (task_127 scaffold)
- `useToolStore`: tool/pen/laser state
- `useViewportStore`: overview/viewport/view-mode/guides state
- `usePlaybackStore`: autoplay/playback/sound state
- `useChromeStore`: panel/paste-helper/data-input/fullscreen/chrome toggles
- `useCapabilityStore`: capability profile and capability checks
- `useUIStoreBridge`: compatibility hook exposing legacy `useUIStore` shape over split stores

### useCanvasStore (state essentials)
- `pages: Record<pageId, CanvasItem[]>`
- `pageOrder: string[]`
- `currentPageId: string` (session)
- `currentStep: number` (session)
- `pageColumnCounts: Record<pageId, number>`
- `stepBlocks: StepBlock[]`
- `anchorMap: AnchorMap | null`
- `audioByStep: Record<number, StepAudio>`
- `animationModInput: ModInput | null`
- `insertionIndex: number`
- `currentStroke: StrokeItem | null`
- `selectedItemId: string | null`
- `layoutSnapshot: PersistedCanvasV2 | null`

**Session reset behavior**
- `hydrate(PersistedSlateDoc)` always sets:
  - `currentStep = 0`
  - `currentPageId = first page`

### useUIStoreBridge (compat essentials)
- Tooling/Laser read-write delegates to `useToolStore`.
- Overview/Viewport/View mode/Guides delegates to `useViewportStore`.
- Playback/Sound delegates to `usePlaybackStore`.
- Panels/Fullscreen/Chrome toggles delegates to `useChromeStore`.
- Capability profile/check delegates to `useCapabilityStore`.

---

## Key Flows (Explicit)

### Data Input → Layout
1) Data panel edits `stepBlocks`.
2) `autoLayout` converts blocks into:
   - `pages`
   - `anchorMap`
   - `pageColumnCounts`
3) Result applied via `useCanvasStore.applyAutoLayout(...)`.

### Playback (Global Step)
1) `useSequence` uses `currentStep` + `currentPageId`.
2) Filters items by `stepIndex === currentStep`.
3) If `audioByStep[currentStep]` exists:
   - start audio via `useAudioPlayer`
   - start animation
   - wait for **both** to complete
4) If no audio:
   - wait for animation
5) Delay `autoPlayDelayMs`, then `nextStep()`.

### Rich Text Animation Pipeline
1) `ContentLayer` routes active text items through `RichTextAnimator` (single entrypoint).
2) `compileAnimationPlan` classifies content as `text` / `math` / `mixed`.
3) `measureAnimationPlan` collects run metrics.
4) `playAnimationPlan` executes timeline phases (text reveal, highlight, math reveal).
5) Profile resolution is format-agnostic:
   - external mod payload -> `normalizeModProfile` -> internal `AnimationProfile`.
6) text-only / math-only / mixed all use the same plan/measure/runtime path.
7) Animation runtime must remain font-agnostic:
   - no font-name hardcoding in runtime/model modules.

### Persistence (Doc-only)
- Local autosave and `.slate` export **store doc only**.
- Session fields are never saved.
- `animationModInput` and text segment style payload are persisted with doc data.

### Contract Normalization (Provisional)
1) Tool adapters return `ToolResult` envelope.
2) Tool execution candidates are checked against `ToolRegistry` contract.
3) Core contract guards validate `ToolResult`.
4) `normalized` payload is validated as one of:
   - `NormalizedContent`
   - `RenderPlan`
   - `TTSScript`
   - `ImageAssetPayload`
   - `VideoAssetPayload`
   - `AudioAssetPayload`
5) Export/interchange 경로는 `NormalizedContent`만 수용하며, 나머지 타입은 deterministic error로 반환한다.
6) Provider adapter ABI(`provider-adapter-abi.v1`)는 `features/extensions/adapters/providerAbi.ts`에서 deterministic request/response envelope을 강제한다.
7) Connector path(`core/extensions/connectors.ts`)는 registered-tool adapter lookup -> invoke -> ToolResult validate 경로를 담당하고, optional adapter route hook을 지원한다.
8) Connector preflight hook은 local runtime sandbox 정책(`core/extensions/localAiSandboxPolicy.ts`)을 통해 local adapter 실행을 allow/deny한다.
9) Capability router(`features/extensions/routing/capabilityRouter.ts`)는 category/capability/cost/latency 기반으로 adapter 후보를 deterministic selection한다.
10) Local-cloud fallback resolver(`features/extensions/routing/localCloudFallback.ts`)는 local-first 체인으로 adapter를 재선정한다.
11) MCP `call_tool` command route는 command bus 경로를 사용하며, connector path와 별도로 정책/검증을 적용한다.
12) Provider/MCP/local transport adapters stay in `features/extensions/adapters/**`.
13) Extension observability(`features/observability/auditLogger.ts`)는 adapter registration/routing/execution/sandbox 이벤트를 redacted JSON-safe payload로 기록한다.
14) Local runtime handshake(`core/extensions/localRuntimeHandshake.ts`)는 local adapter 실행에 필요한 session envelope validation/expiry check를 제공한다.
15) AI output asset pipeline(`core/extensions/aiOutputAssetPipeline.ts`)는 multimodal payload를 deterministic descriptor로 normalize한다.

### Command Bus / Plugin / MCP (Current Runtime)
1) Declarative plugin clicks and MCP `call_tool` command route 모두 `core/engine/commandBus.ts`로 진입한다.
2) Command bus preflight:
   - payload validator 실행
   - role 판정 (`host | student`)
   - `student + requiresApproval`이면 실행 차단 후 `useSyncStore.pendingAIQueue`로 enqueue
3) Role policy는 `core/config/rolePolicy.ts`에서 중앙화되며, unknown role/surface/action은 deny-by-default로 평가된다.
4) Command/tool approval queue routing hooks는 `features/extensions/commandExecutionPolicy.ts` / `features/extensions/toolExecutionPolicy.ts`에서 role policy를 사용한다.
5) Policy shadow mode(`NEXT_PUBLIC_POLICY_SHADOW=1`)가 켜지면 legacy vs policy 결정 차이를 `features/policy/policyShadow.ts`에서 diff 로깅한다.
6) Core command set(`insertBlock`, `updateBlock`, `deleteBlock`, `setViewMode`, `setAnimating`, `addPage`, `deletePage`, `setColumnCount`, ...)은 `features/extensions/commands/registerCoreCommands.ts`에서 등록된다.
4) Declarative plugin manifest는 `core/extensions/pluginLoader.ts`에서 strict guard로 검증된다.
   - `ui.type`: `button | panel`
   - known slot names only
   - JSON-safe payload/context only
   - no arbitrary function/component injection
5) MCP gateway는 `core/extensions/mcpGateway.ts`에서 postMessage로 동작한다.
   - origin allowlist: `NEXT_PUBLIC_ALLOWED_ORIGIN`
   - handshake token: `NEXT_PUBLIC_MCP_CAPABILITY_TOKEN`
   - session token 발급 후에만 `list_tools` / `call_tool` 허용

---

## Dependency Map (Practical)
**High-level dependency direction**
```
core  -> (no deps outside core)
ui    -> core
features -> core + ui
app   -> features + ui
```

**Concrete dependency hotspots**
- `features/layout/autoLayout.ts`
  - `@core/config/boardSpec`
  - `@core/config/typography`
  - `@core/math/loader`
  - `@core/math/render`
  - `@core/types/canvas`
- `features/hooks/usePersistence.ts`
  - `@core/migrations/migrateToV2`
  - `@core/persistence/buildPersistedDoc`
  - `@core/config/boardSpec`
  - `@core/config/typography`
  - `@features/store/useCanvasStore`
  - `@features/store/useUIStoreBridge`
- `features/hooks/useFileIO.ts`
  - `@core/migrations/migrateToV2`
  - `@core/persistence/buildPersistedDoc`
  - `@features/store/useCanvasStore`
- `features/hooks/useSequence.ts`
  - `@features/store/useCanvasStore`
  - `@features/hooks/useAudioPlayer`
  - `@features/hooks/useSFX`
- `features/canvas/animation/RichTextAnimator.tsx`
  - `@features/animation/model/*`
  - `@features/animation/modding/*`
  - `@features/animation/plan/*`
  - `@features/animation/runtime/*`
  - `@core/math/loader`
  - `@core/math/render`
  - `@features/hooks/useBoardTransform`
- `features/store/useCanvasStore.ts`
  - `@core/config/typography`
  - `@core/types/canvas`
- `core/export/exportPipeline.ts`
  - `@core/contracts/index`

---

## Algorithm Notes (Implementation-Level)

### autoLayout (features/layout/autoLayout.ts)
1) Create **hidden container** with column CSS.
2) For each `StepBlock`:
   - `page-break`: reset container, new page, create anchor at padding origin (48,48).
   - `line-break` / `column-break`: append spacer (`line-break-spacer` / `force-break`), measure anchor.
   - `content`: build DOM nodes, typeset MathJax, check overflow.
3) If overflow: new page, re-append current content.
4) `measureStep` → produce **absolute CanvasItems** + **AnchorPositions**.
5) Output `{ pages, pageOrder, pageColumnCounts, anchorMap }`.

### Playback (features/hooks/useSequence.ts)
1) Collect items where `item.stepIndex === currentStep`.
2) If `audioByStep[currentStep]` exists:
   - play audio (useAudioPlayer)
   - run animation loop (useSequence + animator on active item)
   - await **both** to finish
3) If no audio:
   - run animation only
4) Delay `autoPlayDelayMs`, then `nextStep()`.

### Animation Runtime (features/animation/*)
1) Build plan from typeset DOM:
   - `compileAnimationPlan` creates ordered runs.
2) Measure:
   - `measureAnimationPlan` computes run metrics.
3) Play:
   - `playAnimationPlan` drives rAF timeline with pause/skip/stop/speed.
4) Profile:
   - `normalizeModProfile` converts external mod input (format-agnostic) into `AnimationProfile`.

### Migration (core/migrations/migrateToV2.ts)
1) Normalize pages (`pages`, `pageOrder`).
2) Normalize items (stroke/text/image/math/unknown).
3) Normalize `stepBlocks` (segment order/style) and sanitize rich text HTML/class allowlist.
4) Normalize `animationModInput` if present.
5) Ensure at least 1 page exists.
6) Normalize version (2 or 2.1), return **doc-only** payload (no session fields).

### Persistence (features/hooks/usePersistence.ts)
1) `saveSnapshot` filters **image items** for local storage.
2) Saves **PersistedSlateDoc** only.
3) `hydrate` always resets `currentStep=0` + first page.
4) Autosave is debounce-based on store changes.

### File I/O (.slate) (features/hooks/useFileIO.ts)
**Export**
1) Collect image assets → map to `assets/images/*`
2) Rewrite `image.src` to asset path
3) Write `manifest.json` + `board.json` (doc-only)
**Import**
1) Load `board.json` → `migrateToV2`
2) Map `assets/*` to Blob URLs
3) Hydrate store with doc-only data

---

## Store Mutators (Summary)

### useCanvasStore (selected actions)
- `addStroke`, `addItem`, `updateItem`, `deleteItem`: mutate `pages` items.
- `importStepBlocks`: rebuilds `pages`, clears `anchorMap`, resets `currentStep=0`.
- `insertBreak`: inserts break block at target index, rebuilds layout.
- `applyAutoLayout`: apply `{ pages, pageOrder, anchorMap }`, reset step.
- `setColumnCount / increaseColumns / decreaseColumns`: adjust per-page column counts.
- `addPage / deletePage / goToPage / isPageEmpty`: page management helpers.
- `setStepAudio / clearStepAudio`: mutate `audioByStep`.
- `setAnimationModInput`: updates persisted modding payload for animation profile input.
- `nextStep / prevStep / goToStep / resetStep`: session-only step navigation.
- `nextPage / prevPage`: session-only page navigation.
- `captureLayoutSnapshot / restoreLayoutSnapshot`: doc snapshot + restore.

### useUIStoreBridge (selected actions)
- `triggerPlay / triggerStop / triggerSkip`: increments signal counters.
- `toggleBreakGuides / toggleCanvasBorder`: layout guide visibility toggles.
- `setAutoPlay / setPaused`: playback controls.
- `setPlaybackSpeed / setAutoPlayDelay`: timing controls.
- `openDataInput / closeDataInput`: data panel visibility.

---

## Persistence: Doc vs Session

**PersistedSlateDoc (saved/exported)**
```json
{
  "version": 2,
  "pages": { "page-1": [] },
  "pageOrder": ["page-1"],
  "pageColumnCounts": { "page-1": 2 },
  "stepBlocks": [],
  "anchorMap": {},
  "audioByStep": {},
  "animationModInput": null
}
```

**Session state (runtime only)**
```json
{
  "currentPageId": "page-1",
  "currentStep": 0
}
```

---

## Extension Scaffolding (Contract-first Boundary)
Located in `core/extensions/`:
- `manifest.ts`: permissions, triggers, UI placement
- `registry.ts`: extension registry + tool registry entry store
- `connectors.ts`: registered-tool gate + adapter lookup/invoke contract + ToolResult validation
- `pluginLoader.ts`: strict declarative plugin manifest v1 validator/registry
- `mcpGateway.ts`: postMessage-based MCP-compatible secure gateway runtime
- `runtime.ts`: script manifest + trigger registry (no direct network execution)

Located in `features/extensions/adapters/`:
- `types.ts`: adapter interface (`adapterId`, `supports`, `invoke`, `health`)
- `registry.ts`: feature-layer adapter registry (`register/get/list/clear`)
- `mockAdapter.ts`: deterministic local adapter for boundary validation
- `index.ts`: adapter exports + default registration helper

Located in `features/extensions/`:
- `commandExecutionPolicy.ts`: command bus role/approval queue policy hooks
- `toolExecutionPolicy.ts`: connector tool execution role/approval queue policy hooks
- `commands/registerCoreCommands.ts`: core command registrations for doc mutation facade
- `ui/ExtensionRuntimeBootstrap.tsx`: slot/adapters/policy/command/mcp runtime bootstrap
- `ui/registerCoreDeclarativeManifest.ts`: declarative core toolbar shadow/cutover manifest registration
- `ui/registerCoreSlots.ts`: core slot registrations (pending approvals + layout cutover slot components)
- `ui/CoreSlotComponents.tsx`: slot-wrapped core UI components for phased layout cutover

**Permission scope examples**
- `canvas:read`, `canvas:write`, `net:http`, `llm:invoke`

---

## Invariants (Do Not Break)
- **Global Step**: never reset per-page.
- **Doc-only persistence**: never store session fields.
- **Sanitize HTML**: any `innerHTML` must be sanitized upstream (DOMPurify or allowlist sanitizer).
- **Layer boundaries**: `core` must not import `features` or `ui`.
- **JSON-safe persistence**: no DOM/Function in persisted payloads.
- **Zustand selector stability**: avoid inline object selectors like `useStore((s) => ({ ... }))` unless shallow-equality is applied; prefer primitive/function selectors to prevent client render-loop crashes.

---

## Common Entry Points
- Next app shell: `app/layout.tsx`
- Layout root: `features/layout/AppLayout.tsx`
- Mod Studio shell: `features/mod-studio/core/ModStudioShell.tsx`
- Realtime sync hook: `features/sync/useAsymmetricSessionSync.ts`
- Playback engine: `features/hooks/useSequence.ts`
- Persistence: `features/hooks/usePersistence.ts`
- File I/O: `features/hooks/useFileIO.ts`
- Data input panel: `features/layout/DataInputPanel.tsx`
- Input studio headless hook: `features/input-studio/hooks/useInputStudioHeadless.ts`
- Input studio schema editor: `features/input-studio/schema/StructuredSchemaEditor.tsx`
- Input studio LLM draft workflow: `features/input-studio/llm/useInputStudioLlmDraft.ts`
- Input studio batch validation pipeline: `features/input-studio/validation/batchTransformPipeline.ts`
- Auto layout: `features/layout/autoLayout.ts`

---

## Migration Baseline (Task 119~158)
- Baseline info check:
  - `scripts/check_v10_migration_baseline.sh`
- Legacy freeze guard:
  - `scripts/check_v10_legacy_freeze.sh`
  - threshold source: `codex_tasks/workflow/legacy_budget.env`
  - update helper: `scripts/update_legacy_budget.sh`
- Layer boundary check:
  - `scripts/check_layer_rules.sh`
- Hardcoding budget gate (theme/style regression guard):
  - `scripts/check_v10_hardcoding_budget.sh`
  - budget source: `codex_tasks/workflow/style_budget.env`
- Module-scoped theme boundary guard:
  - `scripts/check_v10_module_theme_scope.sh`
  - checks sanitized `--mod-*`/`--theme-*` variable generation path.
- Theme visual contract gate:
  - `scripts/check_v10_theme_visual_gate.sh`
  - contract test: `v10/tests/theme_visual_gate.mjs`
- Viewport contract gate (tablet/mobile baseline):
  - `scripts/check_v10_viewport_contract.sh`
  - contract source: `src/core/config/viewportContract.ts`
- Command write-path baseline gate:
  - `scripts/check_v10_command_write_path.sh`
  - budget source: `codex_tasks/workflow/command_path_budget.env`
- Public feature-flag governance gate:
  - `scripts/check_v10_feature_flag_registry.sh`
  - registry source: `codex_tasks/workflow/feature_flag_registry.env`
- Repository shell verification bundle:
  - middle wave: `VERIFY_STAGE=mid bash scripts/run_repo_verifications.sh`
  - end wave: `VERIFY_STAGE=end bash scripts/run_repo_verifications.sh`
- Lint/build stage helper:
  - `scripts/check_v10_changed_lint.sh`
- Build gates:
  - `cd v10 && npm run lint`
  - `cd v10 && npm run build`
- Beta release gate:
  - `bash scripts/run_beta_quality_gate.sh`
  - includes: layer guard + theme visual gate + lint/build + smoke/perf/a11y
  - perf budget source: `codex_tasks/workflow/perf_budget.env`
- Task generation helper (DAG metadata template-based):
  - `scripts/new_codex_task.sh`

Current migration command domains (source of truth):
- `features/extensions/commands/registerCoreCommands.ts` -> `COMMAND_MIGRATION_MAP`
- Optional policy/shadow/cutover flags:
  - `NEXT_PUBLIC_POLICY_SHADOW=1`: enable policy shadow diff telemetry (legacy vs policy decisions).
  - `NEXT_PUBLIC_CORE_MANIFEST_SHADOW=1`: force-enable declarative core manifest shadow registration.
  - `NEXT_PUBLIC_CORE_TOOLBAR_CUTOVER=0`: disable declarative toolbar cutover path (default is enabled).
  - `NEXT_PUBLIC_LAYOUT_SLOT_CUTOVER=0`: disable layout slot cutover path (default is enabled).
