# 미래 통합을 위한 아키텍처 가이드라인 (Architectural Constitution)

이 문서는 현재의 초기 프로젝트가 향후 대규모 교육 플랫폼의 핵심 모듈로 통합될 것을 전제로 작성된 기술적 요구사항입니다.
AI 에이전트는 코드 작성 및 리뷰 시, 기능 구현 여부보다 "이 코드가 미래의 시스템에 통합될 때 문제가 없는가?"를 최우선 기준으로 판단해야 합니다.

---

## 1. [FRONTEND] 모듈화와 격리 (Isolation)
목표: 이 에디터를 다른 웹 애플리케이션의 컴포넌트나 iframe으로 삽입해도 충돌 없이 동작해야 한다.

- 전역 오염 금지 (No Global Scope Pollution):
  - `window` 객체에 변수나 함수를 직접 할당하는 것을 엄격히 금지한다.
  - 모든 로직은 ES Modules (`import/export`) 또는 네임스페이스 객체 내부로 캡슐화한다.
- UI와 로직의 분리 (Decoupling):
  - 순수 데이터 처리 로직(수식 파싱, 변환 등)과 DOM 조작 코드(`document.querySelector` 등)가 분리되어야 한다.
  - 점검 기준: "HTML/DOM이 없는 Node.js 환경에서도 계산 로직만 따로 실행할 수 있는가?"
- 이벤트 기반 통신:
  - 컴포넌트 간의 직접 참조 대신, 커스텀 이벤트(Event Dispatch)나 상태 관리 모듈을 통해 통신한다.

## 2. [DATA] 데이터 표준과 호환성 (Interoperability)
목표: 이 에디터가 생성한 데이터를 다른 LMS(학습 관리 시스템)나 채점 서버가 별도 변환 없이 읽을 수 있어야 한다.

- 데이터 스키마 준수:
  - 저장되는 데이터(JSON)의 구조는 명확히 정의된 키와 타입을 따라야 한다.
  - 특정 JS 런타임에 종속적인 객체(Function, DOM Element)는 데이터에 포함될 수 없다. (순수 JSON 지향)
- 설정과 데이터의 분리 (SSOT):
  - 사용자 콘텐츠(문제, 정답)와 에디터 설정(폰트, 레이아웃)은 분리하여 저장한다.
  - 환경 설정은 `config.js` 등 단일 소스에서 관리한다.

## 3. [SECURITY] 보안과 무결성 (Security)
목표: 외부에서 악의적인 파일이 로드되더라도 시스템 전체의 보안이 위협받지 않아야 한다.

- XSS 방지 및 소독 (Sanitization):
  - `innerHTML` 사용 시, 외부 입력값에 대한 철저한 소독(Sanitize) 과정을 거쳐야 한다.
  - `eval()`, `new Function()` 등 실행 가능한 문자열 파싱은 원천 차단한다.
- 입력 데이터 검증:
  - 외부에서 불러온 파일(JSON, 이미지)은 신뢰하지 않으며, 사용 전 반드시 스키마 유효성 검사를 수행한다.
  - 비정상적인 데이터 입력 시 시스템이 중단되지 않고 적절한 에러 처리를 수행해야 한다.

## 4. [BACKEND] 서버 사이드 연동 준비 (Backend Readiness)
목표: 향후 Python/Node.js 백엔드와 연동될 때를 대비하여 통신 규격을 준수한다.

- API 통신 규격 고려:
  - 데이터 요청과 응답은 비동기(`async/await`)로 처리하며, RESTful 구조를 지향한다.
- 하드코딩 금지:
  - API 엔드포인트, 인증 키, 비밀번호 등은 코드 내부에 하드코딩하지 않고 환경 변수나 설정 파일에서 주입받는다.

## 5. [CODE QUALITY] 유지보수성 (Maintainability)
목표: 프로젝트 규모가 커져도 코드의 복잡도를 제어할 수 있어야 한다.

- 좀비 코드 제거:
  - 주석 처리된 구버전 코드, 디버깅용 `console.log`는 커밋 전에 반드시 삭제한다.
- 명확한 네이밍:
  - 변수명과 함수명은 축약어 대신, 해당 도메인(교육, 에디터)의 용어를 사용하여 의도를 명확히 한다.
- 문서화:
  - 주요 함수의 상단에는 JSDoc(또는 이에 준하는 주석)을 작성하여 입력값과 반환값의 타입을 명시한다.

## 6. [FORWARD COMPATIBILITY] 프로토콜/스키마 호환성 (Protocol Integrity)
목표: v10과 다른 교육 앱/도구가 확장되어도 기존 데이터와 연동이 깨지지 않아야 한다.

- 계약 우선:
  - 교환/도구 계약(예: NormalizedContent, RenderPlan, TTSScript, ToolResult)은 하위 호환을 기본으로 유지한다.
- 버전 관리와 마이그레이션:
  - 호환성 파괴 변경은 버전 증가와 마이그레이션 경로/도구 제공이 필수다.
- 어댑터 경계:
  - 모델/도구/서비스 특화 로직은 어댑터 레이어에 격리하고 core에 직접 두지 않는다.
- 리팩토링 원칙:
  - 작은 배치로 진행하며 동작 동일성 유지, 레이어 경계 위반 및 스파게티 구조를 금지한다.
- 교차 앱 교환:
  - v10과 pdf-builder 등 다른 앱과의 교환 계약은 문서화하고, 변경 시 호환성을 우선한다.

## 7. [INK UX LAYOUT] 필기 UX 중심 레이아웃 제어 (Ink-first Layout Control)
목표: 레이아웃/패널/오버레이를 시각 요소가 아니라 필기 입력 품질을 결정하는 제어 계층으로 관리한다.

- 레이아웃 변경의 성격:
  - 레이아웃 변경은 "디자인 변경"이 아니라 "입력 경험 변경"으로 취급한다.
- 태블릿 검증 기준(필수):
  - `768x1024`, `820x1180`, `1024x768`, `1180x820`에서 캔버스 가시성과 주요 컨트롤 도달 가능성을 확인한다.
- 필기 연속성 보장:
  - 고정 패널/오버레이가 포인터 경로를 예기치 않게 막지 않아야 하며, 닫기/복귀 액션이 항상 즉시 접근 가능해야 한다.
- 구조 확정 절차:
  - Gemini 초기 SVG -> Codex redline(숫자 기준) -> Gemini 1회 수정 -> Codex 소배치 구현.
- 회귀 방지:
  - 좌표/크기 충돌이 남아 있으면 구현을 시작하지 않는다.
  - 레이아웃 리팩토링은 app shell -> panel/drawer -> footer controls -> overlays 순서로 분할 진행한다.

---

## AI 에이전트 지침 예시
"현재 `js/main.js`의 파일 로드 기능을 수정 중이다. `PROJECT_BLUEPRINT.md`의 3. [SECURITY]와 2. [DATA] 항목을 기준으로, 현재 코드가 외부의 오염된 JSON 파일을 불러올 때 안전한지 검토하고 개선안을 제시하라."

---

## 수석 아키텍트 모드 프롬프트
지금부터 너는 이 프로젝트의 수석 아키텍트 모드로 동작한다.
너의 임무는 내가 작성한 코드를 단순히 실행하거나 수정하는 것이 아니라, 루트 디렉토리에 있는 `PROJECT_BLUEPRINT.md` 문서를 기준으로 "미래의 위험 요소를 차단"하는 것이다.

행동 수칙
1. 내가 "코드 점검해줘" 또는 "리뷰해줘"라고 요청하면, 즉시 코드를 수정하지 말고 먼저 생각하라.
2. 현재 수정된 파일의 종류(JS, HTML 등)와 내용을 분석하여, `PROJECT_BLUEPRINT.md`의 5가지 원칙 중 가장 시급하게 점검해야 할 항목 2~3가지를 추려라.
3. 나에게 다음과 같은 양식으로 선택지를 제안하라.

제안 양식 예시
"`js/main.js` 파일 수정을 감지했습니다. `PROJECT_BLUEPRINT.md`에 따라 다음 관점의 점검이 필요합니다. 어떤 것을 우선적으로 수행할까요?"

1. [FRONTEND] 전역 변수 오염 및 DOM 결합도 점검
   - 이유: 나중에 이 코드가 다른 앱의 부품으로 들어갈 때 충돌이 우려됩니다.
2. [SECURITY] 외부 파일 로드 시 보안 취약점 점검
   - 이유: `innerHTML` 사용 부분이 있어 악성 스크립트 주입이 의심됩니다.
3. [CLEAN] 좀비 코드 및 디버깅 로그 정리
   - 이유: 주석 처리된 구버전 코드가 남아있어 가독성을 해칩니다.

사용자님, 번호를 선택하거나 "전부 진행"이라고 말씀해주세요.
